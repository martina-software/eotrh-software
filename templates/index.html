<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOTRH Clinic Assistant</title>
    <!-- Libraries JS (CDN recomanat per simplicitat) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bernii/gauge.js@1.3.7/dist/gauge.min.js"></script>
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Barra de Progrés -->
        <nav class="progress-bar">
            <ul>
                <li id="progress-step-1" class="step active"><span>1</span> Pujar Imatge</li>
                <li id="progress-step-2" class="step"><span>2</span> Edició ROI</li>
                <li id="progress-step-3" class="step"><span>3</span> Dades Manuals</li>
                <li id="progress-step-4" class="step"><span>4</span> Resultats</li>
            </ul>
        </nav>

        <main class="content-area">
            <!-- Contenidor del formulari (pot englobar tots els passos o només els necessaris) -->
            <form id="diagnosis-form" action="/calculate" method="post" enctype="multipart/form-data">
                <!-- Camp ocult per dades ROI -->
                <input type="hidden" id="roi_data" name="roi_data" value="[]">

                <!-- =========== PAS 0: Benvinguda / Pujar Imatge =========== -->
                <div id="step-upload" class="step-content active">
                    <header class="step-header">
                        <h2>Benvingut/da a l'Assistent de Diagnòstic EOTRH</h2>
                        <p class="step-explanation">
                            {{ explanations.upload }}
                        </p>
                    </header>
                    
                    <!-- Input oculto (fuera del área de carga) -->
                    <input type="file" id="image" name="image" accept="image/jpeg, image/png, image/bmp, image/tiff" required class="hidden-input">
                    
                    <!-- Label asociado al input (todo el área de carga) -->
                    <label for="image" class="upload-area" id="upload-zone">
                        <img src="{{ url_for('static', path='img/icon-upload.svg') }}" alt="Pujar" class="upload-icon">
                        <p>Arrossega aquí la radiografia o <strong>fes clic per seleccionar</strong></p>
                        <div id="file-name-display"></div>
                        <!-- Contenidor per la miniatura de la imatge -->
                        <div id="image-preview-container" style="display: none; margin-top: 15px; text-align: center;"></div>
                    </label>
                    
                    <div class="navigation-buttons">
                        <button type="button" id="start-analysis-button" disabled>Iniciar Anàlisi</button>
                    </div>
                </div>

                <!-- =========== PAS 0.5: Càrrega (Spinner) =========== -->
                <div id="step-loading" class="step-content loading-screen">
                     <img src="{{ url_for('static', path='img/loading.gif') }}" alt="Carregant..." class="loading-spinner">
                    <!-- <div class="css-spinner"></div> --> <!-- Alternativa CSS -->
                    <p>Processant imatge...</p>
                </div>

                <!-- =========== PAS 1: Editor ROI =========== -->
                <div id="step-roi-editor" class="step-content roi-editor-screen">
                     <header class="step-header">
                        <h2>Editor de Regions d'Interès (ROI)</h2>
                        <p class="step-explanation">
                            {{ explanations.roi }}
                        </p>
                    </header>
                    <div class="editor-layout">
                        <aside class="roi-toolbar">
                             <button type="button" id="tool-select" class="tool-button active" title="Seleccionar/Moure (S)">
                                 <img src="{{ url_for('static', path='img/icon-select.svg') }}" alt="Seleccionar">
                             </button>
                            <button type="button" id="tool-polygon" class="tool-button" title="Dibuixar Polígon (P)">
                                <img src="{{ url_for('static', path='img/icon-polygon.svg') }}" alt="Polígon">
                            </button>
                            <button type="button" id="tool-freehand" class="tool-button" title="Dibuix Lliure (F)">
                                <img src="{{ url_for('static', path='img/icon-freehand.svg') }}" alt="Llapis">
                            </button>
                            <div class="tool-options" id="freehand-options" style="display:none;">
                                <label for="brush-size">Gruix:</label>
                                <input type="range" id="brush-size" min="1" max="20" value="3">
                                <span id="brush-size-value">3</span>px
                            </div>
                             <button type="button" id="tool-grid" class="tool-button" title="Mostrar/Ocultar Graella (G)">
                                 <img src="{{ url_for('static', path='img/icon-grid.svg') }}" alt="Graella">
                             </button>
                            <hr>
                             <button type="button" id="tool-undo" class="tool-button" title="Desfer (Ctrl+Z)">
                                 <img src="{{ url_for('static', path='img/icon-undo.svg') }}" alt="Desfer">
                             </button>
                             <button type="button" id="tool-redo" class="tool-button" title="Refer (Ctrl+Y)">
                                 <img src="{{ url_for('static', path='img/icon-redo.svg') }}" alt="Refer">
                             </button>
                            <button type="button" id="tool-delete" class="tool-button" title="Esborrar Seleccionat (Supr)">
                                <img src="{{ url_for('static', path='img/icon-delete.svg') }}" alt="Esborrar">
                            </button>
                        </aside>
                        <section class="canvas-section">
                            <div id="canvas-wrapper">
                                <!-- La graella es pot afegir com a fons CSS o dibuixada al canvas -->
                                <canvas id="roi-canvas"></canvas>
                            </div>
                             <div id="polygon-help-roi" class="tool-tip" style="display: none;">
                                 Feu clic per afegir punts. Doble clic o clic al primer punt per tancar.
                             </div>
                        </section>
                    </div>
                     <div class="navigation-buttons">
                         <button type="button" class="secondary" onclick="navigateStep('step-upload')">Tornar</button>
                        <button type="button" id="confirm-rois-button">Confirmar ROIs i Continuar</button>
                    </div>
                </div>

                <!-- =========== PAS 2: Dades Manuals (Tabs) =========== -->
                <div id="step-manual-data" class="step-content">
                    <header class="step-header">
                        <h2>Avaluació Manual</h2>
                         <p class="step-explanation">
                            {{ explanations.manual }}
                         </p>
                    </header>
                    <!-- Navegació per Pestanyes -->
                    <div class="tab-nav">
                        <button type="button" class="tab-link active" onclick="openTab(event, 'tab-clinical')">Signes Clínics</button>
                        <button type="button" class="tab-link" onclick="openTab(event, 'tab-radiographic')">Signes Radiològics</button>
                    </div>

                    <!-- Contingut Pestanyes (similar a abans, però sense emojis i amb classes per estil JS si cal) -->
                     <div id="tab-clinical" class="tab-content" style="display: block;">
                         <h3>Signes Clínics (Tretow et al., 2025)</h3>
                         <!-- ... Formulari clínic (opcions sense emojis) ... -->
                          {% for key, options in clinical_options.items() %}
                         <div class="form-group">
                             <label for="{{ key }}">{{ key.replace('_', ' ').capitalize() }}:
                                <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="Explicació del signe {{ key }}">
                             </label>
                             <select id="{{ key }}" name="{{ key }}" required class="score-select">
                                 {% for option_text, score in options %} <!-- Ara passem text i puntuació separats -->
                                     <option value="{{ option_text }} ({{score}} punts)" data-score="{{ score }}">{{ option_text }} ({{ score }} punts)</option>
                                 {% endfor %}
                             </select>
                         </div>
                         {% endfor %}
                     </div>
                     <div id="tab-radiographic" class="tab-content">
                          <h3>Signes Radiològics (Tretow et al., 2025)</h3>
                         <!-- ... Formulari radiològic (opcions sense emojis) ... -->
                          {% for key, options in radiographic_options.items() %}
                          <div class="form-group">
                              <label for="{{ key }}">{{ key.replace('_', ' ').capitalize() }}:
                                 <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="Explicació del signe {{ key }}">
                              </label>
                              <select id="{{ key }}" name="{{ key }}" required class="score-select">
                                  {% for option_text, score in options %}
                                      <option value="{{ option_text }} ({{score}} punts)" data-score="{{ score }}">{{ option_text }} ({{ score }} punts)</option>
                                  {% endfor %}
                              </select>
                          </div>
                          {% endfor %}
                     </div>

                     <div class="navigation-buttons">
                         <button type="button" class="secondary" onclick="navigateStep('step-roi-editor')">Tornar a Edició ROI</button>
                        <button type="submit" id="calculate-button">Calcular Diagnòstic</button>
                    </div>
                </div>

            </form> <!-- Fi del formulari -->

            <!-- =========== PAS 3: Resultats =========== -->
             <!-- El backend ha de passar "results" quan existeixin -->
             {% if results %}
            <div id="step-results" class="step-content results-screen active"> <!-- Mostra si hi ha resultats -->
                 <header class="step-header">
                     <h2>Resultat de l'Avaluació Integrada</h2>
                     <p class="step-explanation">
                        {{ explanations.results }}
                     </p>
                 </header>

                 <div class="results-layout">
                     <section class="results-details">
                         <h3>Desglossament de Puntuacions</h3>
                         <div class="score-breakdown">
                             <div class="score-item">
                                 <h4>Clínica <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="Basada en observacions directes del pacient."></h4>
                                 <p>{{ results.puntuacio_clinica }} / 17</p>
                                 <div class="score-bar-container"><div class="score-bar clinical" style="width: {{ (results.puntuacio_clinica / 17 * 100)|int }}%;"></div></div>
                             </div>
                             <div class="score-item">
                                 <h4>Radiològica <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="Basada en signes observats a la radiografia."></h4>
                                 <p>{{ results.puntuacio_radio }} / 14</p>
                                 <div class="score-bar-container"><div class="score-bar radiographic" style="width: {{ (results.puntuacio_radio / 14 * 100)|int }}%;"></div></div>
                             </div>
                             <div class="score-item">
                                 <h4>Digital <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="Anàlisi de textura per computador de les ROIs seleccionades (Max DistEn2D: {{ results.max_dist_en_value }})."></h4>
                                 <p>{{ results.puntuacio_digital }} / 10</p>
                                 <div class="score-bar-container"><div class="score-bar digital" style="width: {{ (results.puntuacio_digital / 10 * 100)|int }}%;"></div></div>
                             </div>
                         </div>
                         <p class="interpretation-text">
                             {{ results.interpretacio }}
                         </p>

                         {% if results.roi_analysis_details %}
                         <details class="roi-details-results">
                             <summary>Detalls Anàlisi ROI <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="Resultat de l'anàlisi de textura per a cada regió seleccionada."></summary>
                             <ul>
                             {% for detail in results.roi_analysis_details %}
                                 <li>ROI {{ detail.roi_index }}: DistEn2D = {{ detail.dist_en if detail.dist_en is not none else 'N/A' }} {% if detail.error %}<span class="error-text">(Error: {{ detail.error }})</span>{% endif %}</li>
                             {% endfor %}
                             </ul>
                         </details>
                         {% endif %}
                     </section>

                     <section class="results-summary">
                         <h3>Puntuació Global</h3>
                         <div class="thermometer-display" data-score="{{ results.puntuacio_total_integrada }}" data-max="41">
                             <div class="thermometer-track">
                                 <div class="thermometer-fill"></div>
                             </div>
                             <div class="thermometer-bulb">
                                 <div class="thermometer-percentage">{{ (results.puntuacio_total_integrada / 41 * 100)|round|int }}%</div>
                             </div>
                         </div>
                         <p class="classification-text" id="classification-text-id">
                            <strong>Risc: {{ results.classificacio }}</strong>
                         </p>
                     </section>
                 </div>

                 <div class="navigation-buttons">
                    <button type="button" onclick="window.location.href='/'">Iniciar Nova Avaluació</button>
                 </div>
            </div>
             {% endif %}

        </main>
    </div> <!-- /app-container -->

    <!-- Scripts JS (al final per rendiment) -->
    <script src="{{ url_for('static', path='/js/roi_editor.js') }}"></script>
    <script src="{{ url_for('static', path='/js/app.js') }}"></script>
</body>
</html>