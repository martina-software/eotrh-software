<!DOCTYPE html>
<html lang="{{ config.DEFAULT_LOCALE }}"> <!-- Usa el locale de config -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Usa título desde i18n -->
    <title>{{ i18n.get("app_title", "EOTRH Assistant") }}</title>
    
    <!-- Open Graph / Facebook Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://eotrh-software.onrender.com/">
    <meta property="og:title" content="{{ i18n.get('app_title', 'EOTRH Clinic Assistant') }}">
    <meta property="og:description" content="{{ i18n.get('app_description', 'Assistent de Diagnòstic EOTRH per a professionals veterinaris') }}">
    <meta property="og:image" content="https://eotrh-software.onrender.com{{ url_for('static', path='assets/logo.png') }}">
    
    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://eotrh-software.onrender.com/">
    <meta name="twitter:title" content="{{ i18n.get('app_title', 'EOTRH Clinic Assistant') }}">
    <meta name="twitter:description" content="{{ i18n.get('app_description', 'Assistent de Diagnòstic EOTRH per a professionals veterinaris') }}">
    <meta name="twitter:image" content="https://eotrh-software.onrender.com{{ url_for('static', path='assets/logo.png') }}">
    
    <!-- Libraries JS (CDN) -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script> -->
    <!-- Gauge.js ya no se usa, usamos termómetro CSS -->
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Logo y Título App -->
        <header class="app-header">
             <!-- Logo -->
             <img src="{{ url_for('static', path='assets/logo.png') }}"
                  alt="{{ i18n.get('logo_alt_text', 'App Logo') }}"
                  class="app-logo">
            <h1>{{ i18n.get("app_title", "EOTRH Clinic Assistant") }}</h1>
        </header>

        <!-- Barra de Progrés (usa textos i18n) -->
        <nav class="progress-bar">
            <ul>
                <li id="progress-step-1" class="step active"><span>1</span> {{ i18n.get("progress_step1", "Upload") }}</li>
                <li id="progress-step-2" class="step"><span>2</span> {{ i18n.get("progress_step2", "ROI Edit") }}</li>
                <li id="progress-step-3" class="step"><span>3</span> {{ i18n.get("progress_step3", "Manual Data") }}</li>
                <li id="progress-step-4" class="step"><span>4</span> {{ i18n.get("progress_step4", "Results") }}</li>
            </ul>
        </nav>

        <main class="content-area">
            <!-- Mensaje de Error Global (opcional) -->
            <div id="global-error-message" class="error-message" style="display: none;"></div>

            <!-- Formulario principal -->
            <form id="diagnosis-form" action="{{ url_for('handle_calculation') }}" method="post" enctype="multipart/form-data">
                <!-- Campo oculto ROI -->
                <input type="hidden" id="roi_data" name="roi_data" value="[]">

                <!-- PAS 0: Upload -->
                <div id="step-upload" class="step-content {% if not results %}active{% endif %}">
                    <header class="step-header">
                        <h2>{{ i18n.get("welcome_title", "Welcome") }}</h2>
                        <p class="step-explanation">
                            {{ explanations.upload }} <!-- Texto viene del contexto -->
                        </p>
                    </header>
                    <input type="file" id="image" name="image" accept="image/jpeg, image/png, image/bmp, image/tiff" required class="hidden-input">
                    <label for="image" class="upload-area" id="upload-zone">
                        <img src="{{ url_for('static', path='img/icon-upload.svg') }}" alt="Upload Icon" class="upload-icon">
                        <!-- Usa raw para permitir <strong> -->
                        <p>{{ i18n.get("upload_prompt", "Drag or click") | safe }}</p>
                        <div id="file-name-display"></div>
                        <div id="image-preview-container" style="display: none; margin-top: 15px; text-align: center;"></div>
                    </label>
                    <div class="navigation-buttons">
                        <button type="button" id="start-analysis-button" disabled>{{ i18n.get("start_analysis_button", "Start Analysis") }}</button>
                    </div>
                </div>

                <!-- PAS 0.5: Loading -->
                <div id="step-loading" class="step-content loading-screen">
                     <img src="{{ url_for('static', path='img/loading.gif') }}" alt="Loading..." class="loading-spinner">
                    <p>{{ i18n.get("loading_message", "Processing image...") }}</p>
                </div>

                <!-- PAS 1: Editor ROI -->
                <div id="step-roi-editor" class="step-content roi-editor-screen">
                     <header class="step-header">
                        <h2>{{ i18n.get("roi_editor_title", "ROI Editor") }}</h2>
                        <p class="step-explanation">
                            {{ explanations.roi }}
                        </p>
                    </header>
                    <div class="editor-layout">
                        <aside class="roi-toolbar">
                             <button type="button" id="tool-select" class="tool-button active" title="Seleccionar/Moure (S)">
                                 <img src="{{ url_for('static', path='img/icon-select.svg') }}" alt="Select">
                             </button>
                            <button type="button" id="tool-polygon" class="tool-button" title="Dibuixar Polígon (P)">
                                <img src="{{ url_for('static', path='img/icon-polygon.svg') }}" alt="Polygon">
                            </button>
                            <button type="button" id="tool-freehand" class="tool-button" title="Dibuix Lliure (F)">
                                <img src="{{ url_for('static', path='img/icon-freehand.svg') }}" alt="Freehand">
                            </button>
                            <div class="tool-options" id="freehand-options" style="display:none;">
                                <label for="brush-size">Gruix:</label>
                                <input type="range" id="brush-size" min="1" max="20" value="3">
                                <span id="brush-size-value">3</span>px
                            </div>
                             <!-- Botón Grid Opcional -->
                            <hr>
                             <button type="button" id="tool-undo" class="tool-button" title="Desfer (Ctrl+Z)">
                                 <img src="{{ url_for('static', path='img/icon-undo.svg') }}" alt="Undo">
                             </button>
                             <button type="button" id="tool-redo" class="tool-button" title="Refer (Ctrl+Y)">
                                 <img src="{{ url_for('static', path='img/icon-redo.svg') }}" alt="Redo">
                             </button>
                            <button type="button" id="tool-delete" class="tool-button" title="Esborrar Seleccionat (Supr)">
                                <img src="{{ url_for('static', path='img/icon-delete.svg') }}" alt="Delete">
                            </button>
                        </aside>
                        <section class="canvas-section">
                            <div id="canvas-wrapper">
                                <canvas id="roi-canvas"></canvas>
                            </div>
                             <div id="polygon-help-roi" class="tool-tip" style="display: none;">
                                 {{ i18n.get("polygon_tooltip", "Click to add points...") }}
                             </div>
                        </section>
                    </div>
                     <div class="navigation-buttons">
                         <button type="button" class="secondary" onclick="navigateStep('step-upload')">{{ i18n.get("back_to_upload_button", "Back to Upload") }}</button>
                        <button type="button" id="confirm-rois-button">{{ i18n.get("confirm_rois_button", "Confirm ROIs") }}</button>
                    </div>
                </div>

                <!-- PAS 2: Dades Manuals -->
                <div id="step-manual-data" class="step-content">
                    <header class="step-header">
                        <h2>{{ i18n.get("manual_data_title", "Manual Evaluation") }}</h2>
                         <p class="step-explanation">
                            {{ explanations.manual }}
                         </p>
                    </header>
                    <div class="tab-nav">
                        <button type="button" class="tab-link active" onclick="openTab(event, 'tab-clinical')">{{ i18n.get("tab_clinical", "Clinical Signs") }}</button>
                        <button type="button" class="tab-link" onclick="openTab(event, 'tab-radiographic')">{{ i18n.get("tab_radiographic", "Radiographic Signs") }}</button>
                    </div>

                     <div id="tab-clinical" class="tab-content active" style="display: block;"> <!-- Añadido active y display block inicial -->
                         <h3>{{ i18n.get("clinical_signs_subtitle", "Clinical Signs") }}</h3>
                          {% for key, options_list in clinical_options.items() %}
                         <div class="form-group">
                             <label for="{{ key }}">{{ key.replace('_', ' ').capitalize() }}:
                                <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ i18n.get('info_icon_tooltip', 'More information') }}">
                             </label>
                             <select id="{{ key }}" name="{{ key }}" required class="score-select">
                                 {% for option_text, score in options_list %}
                                     <!-- **CAMBIO CLAVE: value="{{ score }}"** -->
                                     <option value="{{ score }}" data-score="{{ score }}">{{ option_text }} ({{ score }} punts)</option>
                                 {% endfor %}
                             </select>
                         </div>
                         {% endfor %}
                     </div>
                     <div id="tab-radiographic" class="tab-content">
                          <h3>{{ i18n.get("radiographic_signs_subtitle", "Radiographic Signs") }}</h3>
                          {% for key, options_list in radiographic_options.items() %}
                          <div class="form-group">
                              <label for="{{ key }}">{{ key.replace('_', ' ').capitalize() }}:
                                 <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ i18n.get('info_icon_tooltip', 'More information') }}">
                              </label>
                              <select id="{{ key }}" name="{{ key }}" required class="score-select">
                                  {% for option_text, score in options_list %}
                                     <!-- **CAMBIO CLAVE: value="{{ score }}"** -->
                                      <option value="{{ score }}" data-score="{{ score }}">{{ option_text }} ({{ score }} punts)</option>
                                  {% endfor %}
                              </select>
                          </div>
                          {% endfor %}
                     </div>

                     <div class="navigation-buttons">
                         <button type="button" class="secondary" onclick="navigateStep('step-roi-editor')">{{ i18n.get("back_to_roi_button", "Back to ROI Edit") }}</button>
                        <!-- Cambiado a type="submit" -->
                        <button type="submit" id="calculate-button">{{ i18n.get("calculate_button", "Calculate Diagnosis") }}</button>
                    </div>
                </div>

            </form> <!-- Fin del formulario -->

            <!-- PAS 3: Resultats -->
             {% if results %}
            <div id="step-results" class="step-content results-screen active"> <!-- Añadido active si hay results -->
            {% else %}
            <div id="step-results" class="step-content results-screen"> <!-- Añadido para permitir resultados AJAX -->
            {% endif %}
                 <header class="step-header">
                     <h2>{{ i18n.get("results_title", "Results") }}</h2>
                     <p class="step-explanation">
                        {{ explanations.results }}
                     </p>
                 </header>

                 <div class="results-layout">
                     <section class="results-details">
                         <h3>{{ i18n.get("score_breakdown_title", "Score Breakdown") }}</h3>
                         <div class="score-breakdown">
                             <div class="score-item">
                                 <!-- Usa textos i18n -->
                                 <h4>{{ i18n.get("clinical_score_label", "Clinical") }} <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ i18n.get('clinical_score_tooltip', 'Clinical score details') }}"></h4>
                                 <p>{{ results.puntuacio_clinica if results else "0" }} / {{ config.MAX_RAW_SCORES.clinical }}</p>
                                 <div class="score-bar-container"><div class="score-bar clinical" style="width: {{ (results.puntuacio_clinica / config.MAX_RAW_SCORES.clinical * 100)|int if results else 0 }}%;"></div></div>
                             </div>
                             <div class="score-item">
                                 <h4>{{ i18n.get("radiographic_score_label", "Radiographic") }} <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ i18n.get('radiographic_score_tooltip', 'Radiographic score details') }}"></h4>
                                 <p>{{ results.puntuacio_radio if results else "0" }} / {{ config.MAX_RAW_SCORES.radio }}</p>
                                 <div class="score-bar-container"><div class="score-bar radiographic" style="width: {{ (results.puntuacio_radio / config.MAX_RAW_SCORES.radio * 100)|int if results else 0 }}%;"></div></div>
                             </div>
                             <div class="score-item">
                                 <!-- Tooltip dinámico con valor DistEn -->
                                 {% set digital_tooltip = i18n.get('digital_score_tooltip', '').format(max_dist_en_value=results.max_dist_en_value if results else 0) %}
                                 <h4>{{ i18n.get("digital_score_label", "Digital") }} <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ digital_tooltip if digital_tooltip else i18n.get('digital_score_no_tooltip', 'Digital score details') }}"></h4>
                                 <p>{{ results.puntuacio_digital if results else "0" }} / 10</p>
                                 <div class="score-bar-container"><div class="score-bar digital" style="width: {{ (results.puntuacio_digital / 10 * 100)|int if results else 0 }}%;"></div></div>
                             </div>
                         </div>
                         
                         <!-- Nou bloc d'Anàlisi Entropia del ROI -->
                         <div class="entropy-analysis">
                             <h3>{{ i18n.get("entropy_analysis_title", "Anàlisi Entropia del ROI") }}</h3>
                             <div class="entropy-metric">
                                 <label>{{ i18n.get("disten_label", "Distància Entropia 2D (DistEn2D)") }}</label>
                                 <div class="entropy-bar-container">
                                     <!-- Mostrar el valor postprocesado (DistEn2D/2) en la barra -->
                                     <div class="entropy-bar" style="width: {{ ((results.max_dist_en_value / 2) * 100)|round|int if results else 0 }}%;"></div>
                                     <div class="entropy-marker" style="left: {{ ((results.max_dist_en_value / 2) * 100)|round|int if results else 0 }}%;"></div>
                                 </div>
                                 <!-- Mostrar el valor postprocesado como porcentaje -->
                                 <div class="entropy-value">{{ ((results.max_dist_en_value / 2) * 100)|round|int if results else 0 }}%</div>
                             </div>
                             <div class="entropy-interpretation">
                                 <p>
                                     {{ i18n.get("entropy_interpretation", "Aquest valor indica una alta irregularitat en la textura de la dent a la regió analitzada. Pot ser un indicador precoç de canvis morfològics associats a EOTRH, fins i tot amb signes clínics mínims.") }}
                                     <a href="#" class="info-link" onclick="showEntropyInfo(event)">{{ i18n.get("more_info_link", "ℹ️ Més informació") }}</a>
                                 </p>
                             </div>
                             <div class="entropy-technical-note">
                                 <p>{{ i18n.get("entropy_technical_note", "Mesurat segons Distribution Entropy 2D després de filtrat Normalize. Basat en Górski et al. (2022). Útil per detectar fases inicials i avançades d'EOTRH.") }}</p>
                             </div>
                         </div>
                         
                         

                         
                     </section>

                     <section class="results-summary">
                         <h3>{{ i18n.get("integrated_score_title", "Global Score") }}</h3>
                          <!-- Termómetro -->
                         <div class="thermometer-display" data-score="{{ results.puntuacio_total_integrada if results else 0 }}" data-max="{{ config.MAX_INTEGRATED_SCORE }}">
                             <div class="thermometer-track">
                                 <div class="thermometer-fill"></div>
                             </div>
                             <div class="thermometer-bulb">
                                 <div class="thermometer-percentage">{{ (results.puntuacio_total_integrada / config.MAX_INTEGRATED_SCORE * 100)|round|int if results else 0 }}%</div>
                             </div>
                         </div>
                         <!-- Clasificación (texto ya viene de i18n) -->
                         <p class="classification-text" id="classification-text-id">
                            <strong>{{ i18n.get("classification_label", "Risk:") }} {{ results.classificacio if results else i18n.get("none", "None") }}</strong>
                         </p>
                     </section>
                 </div>

                 <p class="interpretation-text">
                    {{ results.interpretacio if results else "" }} <!-- Texto ya viene de i18n vía backend -->
                </p>

                 <div class="navigation-buttons">
                    <!-- Botón para volver al inicio -->
                    <button type="button" onclick="window.location.href='{{ url_for('read_root') }}';">{{ i18n.get("new_evaluation_button", "New Evaluation") }}</button>
                 </div>
            </div>

        </main>

        <footer class="app-footer">
            <p>© {{ now().year }} Desenvolupament de software independent. Version 1.1</p>
        </footer>

    </div> <!-- /app-container -->

    <!-- Scripts JS (al final) -->
    <!-- Primero Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

    <!-- Luego nuestra lógica principal y del editor (AHORA SOLO app.js) -->
    <script src="{{ url_for('static', path='/js/app.js') }}"></script>

    <!-- Modal para información de entropia -->
    <div id="entropy-info-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>{{ i18n.get("entropy_modal_title", "Entropia de Distribució 2D (DistEn2D)") }}</h3>
            <div class="modal-body">
                <p>{{ i18n.get("entropy_modal_p1", "La Distància d'Entropia 2D (DistEn2D) és una mesura de la complexitat i irregularitat de la textura d'una imatge radiogràfica.") }}</p>
                <p>{{ i18n.get("entropy_modal_p2", "En el context de l'EOTRH (Reabsorció Dental Odontoclàstica Equina i Hipercementosi), aquest valor quantifica els canvis morfològics que poden indicar:") }}</p>
                <ul>
                    <li>{{ i18n.get("entropy_modal_li1", "Alteracions precoces en l'estructura dental") }}</li>
                    <li>{{ i18n.get("entropy_modal_li2", "Reabsorció òssia inicial") }}</li>
                    <li>{{ i18n.get("entropy_modal_li3", "Processos de hipercementosi") }}</li>
                </ul>
                <p>{{ i18n.get("entropy_modal_p3", "Un valor més alt (prop del 100%) indica major irregularitat i complexitat en la textura, sovint associat amb estadis més avançats de la malaltia.") }}</p>
                <p>{{ i18n.get("entropy_modal_p4", "Les investigacions de Górski et al. (2022) suggereixen que aquest biomarcador digital podria facilitar la detecció precoç de canvis patològics, fins i tot abans que siguin visibles en radiografies convencionals o es manifestin clínicament.") }}</p>
                <p>{{ i18n.get("entropy_modal_p5", "No obstant, en aquest projecte se n'ha fet una adaptació específica amb una finalitat principalment exploratòria, i els resultats s'han d'interpretar en aquest mateix context.") }}</p>
            </div>
        </div>
    </div>

    <script>
        // Función para mostrar el modal de información de entropía
        function showEntropyInfo(event) {
            event.preventDefault();
            document.getElementById('entropy-info-modal').style.display = 'block';
        }

        // Cerrar el modal cuando se hace clic en la X
        document.querySelectorAll('.close-modal').forEach(function(element) {
            element.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });

        // Cerrar el modal al hacer clic fuera de él
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
    </script>

    <!-- Código para envío AJAX del formulario -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('diagnosis-form');
            
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault(); // Prevenir envío tradicional
                    
                    // Mostrar indicador de carga
                    navigateStep('step-loading');
                    
                    // Crear objeto FormData con los datos del formulario
                    const formData = new FormData(form);
                    
                    // Enviar datos mediante fetch API
                    fetch('/api/calculate', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(results => {
                        // Procesar resultados recibidos
                        console.log('Resultados recibidos:', results);
                        
                        // Actualizar DOM con los resultados
                        updateResultsView(results);
                        
                        // Navegar a la vista de resultados
                        navigateStep('step-results');
                    })
                    .catch(error => {
                        console.error('Error en el envío AJAX:', error);
                        showGlobalError('Error al procesar los datos: ' + error.message);
                        // Volver a la vista anterior
                        navigateStep('step-manual-data');
                    });
                });
            }
            
            // Función para actualizar la vista de resultados con los datos recibidos
            function updateResultsView(results) {
                // Actualizar puntuaciones
                document.querySelector('.score-item:nth-child(1) p').textContent = 
                    `${results.puntuacio_clinica} / {{ config.MAX_RAW_SCORES.clinical }}`;
                document.querySelector('.score-item:nth-child(1) .score-bar').style.width = 
                    `${(results.puntuacio_clinica / {{ config.MAX_RAW_SCORES.clinical }} * 100)}%`;
                
                document.querySelector('.score-item:nth-child(2) p').textContent = 
                    `${results.puntuacio_radio} / {{ config.MAX_RAW_SCORES.radio }}`;
                document.querySelector('.score-item:nth-child(2) .score-bar').style.width = 
                    `${(results.puntuacio_radio / {{ config.MAX_RAW_SCORES.radio }} * 100)}%`;
                
                document.querySelector('.score-item:nth-child(3) p').textContent = 
                    `${results.puntuacio_digital} / 10`;
                document.querySelector('.score-item:nth-child(3) .score-bar').style.width = 
                    `${(results.puntuacio_digital / 10 * 100)}%`;
                
                // Actualizar entropia - mostrar el valor postprocesado (DistEn2D/2)
                const entropyPercentage = Math.round((results.max_dist_en_value / 2) * 100);
                document.querySelector('.entropy-bar').style.width = `${entropyPercentage}%`;
                document.querySelector('.entropy-marker').style.left = `${entropyPercentage}%`;
                document.querySelector('.entropy-value').textContent = `${entropyPercentage}%`;
                
                // Actualizar termómetro
                const thermometerFill = document.querySelector('.thermometer-fill');
                const thermometerPercentage = document.querySelector('.thermometer-percentage');
                if (thermometerFill && thermometerPercentage) {
                    const percentage = Math.round((results.puntuacio_total_integrada / {{ config.MAX_INTEGRATED_SCORE }}) * 100);
                    thermometerFill.style.height = `${percentage}%`;
                    thermometerPercentage.textContent = `${percentage}%`;
                }
                
                // Actualizar clasificación
                document.getElementById('classification-text-id').innerHTML = 
                    `<strong>{{ i18n.get("classification_label", "Risk:") }} ${results.classificacio}</strong>`;
                
                // Actualizar interpretación
                document.querySelector('.interpretation-text').textContent = results.interpretacio;
            }
            
            // Botón de nueva evaluación ahora redirecciona a la raíz sin submit
            const newEvalButtons = document.querySelectorAll('button[onclick*="window.location.href"]');
            newEvalButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = '/';
                });
            });
        });
    </script>

</body>
</html>