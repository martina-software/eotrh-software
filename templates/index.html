<!DOCTYPE html>
<html lang="{{ config.DEFAULT_LOCALE }}"> <!-- Usa el locale de config -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Usa título desde i18n -->
    <title>{{ i18n.get("app_title", "EOTRH Assistant") }}</title>
    <!-- Libraries JS (CDN) -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script> -->
    <!-- Gauge.js ya no se usa, usamos termómetro CSS -->
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Logo y Título App -->
        <header class="app-header">
             <!-- Logo -->
             <img src="{{ url_for('static', path='assets/logo.png') }}"
                  alt="{{ i18n.get('logo_alt_text', 'App Logo') }}"
                  class="app-logo">
            <h1>{{ i18n.get("app_title", "EOTRH Clinic Assistant") }}</h1>
        </header>

        <!-- Barra de Progrés (usa textos i18n) -->
        <nav class="progress-bar">
            <ul>
                <li id="progress-step-1" class="step active"><span>1</span> {{ i18n.get("progress_step1", "Upload") }}</li>
                <li id="progress-step-2" class="step"><span>2</span> {{ i18n.get("progress_step2", "ROI Edit") }}</li>
                <li id="progress-step-3" class="step"><span>3</span> {{ i18n.get("progress_step3", "Manual Data") }}</li>
                <li id="progress-step-4" class="step"><span>4</span> {{ i18n.get("progress_step4", "Results") }}</li>
            </ul>
        </nav>

        <main class="content-area">
            <!-- Mensaje de Error Global (opcional) -->
            <div id="global-error-message" class="error-message" style="display: none;"></div>

            <!-- Formulario principal -->
            <form id="diagnosis-form" action="{{ url_for('handle_calculation') }}" method="post" enctype="multipart/form-data">
                <!-- Campo oculto ROI -->
                <input type="hidden" id="roi_data" name="roi_data" value="[]">

                <!-- PAS 0: Upload -->
                <div id="step-upload" class="step-content {% if not results %}active{% endif %}">
                    <header class="step-header">
                        <h2>{{ i18n.get("welcome_title", "Welcome") }}</h2>
                        <p class="step-explanation">
                            {{ explanations.upload }} <!-- Texto viene del contexto -->
                        </p>
                    </header>
                    <input type="file" id="image" name="image" accept="image/jpeg, image/png, image/bmp, image/tiff" required class="hidden-input">
                    <label for="image" class="upload-area" id="upload-zone">
                        <img src="{{ url_for('static', path='img/icon-upload.svg') }}" alt="Upload Icon" class="upload-icon">
                        <!-- Usa raw para permitir <strong> -->
                        <p>{{ i18n.get("upload_prompt", "Drag or click") | safe }}</p>
                        <div id="file-name-display"></div>
                        <div id="image-preview-container" style="display: none; margin-top: 15px; text-align: center;"></div>
                    </label>
                    <div class="navigation-buttons">
                        <button type="button" id="start-analysis-button" disabled>{{ i18n.get("start_analysis_button", "Start Analysis") }}</button>
                    </div>
                </div>

                <!-- PAS 0.5: Loading -->
                <div id="step-loading" class="step-content loading-screen">
                     <img src="{{ url_for('static', path='img/loading.gif') }}" alt="Loading..." class="loading-spinner">
                    <p>{{ i18n.get("loading_message", "Processing image...") }}</p>
                </div>

                <!-- PAS 1: Editor ROI -->
                <div id="step-roi-editor" class="step-content roi-editor-screen">
                     <header class="step-header">
                        <h2>{{ i18n.get("roi_editor_title", "ROI Editor") }}</h2>
                        <p class="step-explanation">
                            {{ explanations.roi }}
                        </p>
                    </header>
                    <div class="editor-layout">
                        <aside class="roi-toolbar">
                             <button type="button" id="tool-select" class="tool-button active" title="Seleccionar/Moure (S)">
                                 <img src="{{ url_for('static', path='img/icon-select.svg') }}" alt="Select">
                             </button>
                            <button type="button" id="tool-polygon" class="tool-button" title="Dibuixar Polígon (P)">
                                <img src="{{ url_for('static', path='img/icon-polygon.svg') }}" alt="Polygon">
                            </button>
                            <button type="button" id="tool-freehand" class="tool-button" title="Dibuix Lliure (F)">
                                <img src="{{ url_for('static', path='img/icon-freehand.svg') }}" alt="Freehand">
                            </button>
                            <div class="tool-options" id="freehand-options" style="display:none;">
                                <label for="brush-size">Gruix:</label>
                                <input type="range" id="brush-size" min="1" max="20" value="3">
                                <span id="brush-size-value">3</span>px
                            </div>
                             <!-- Botón Grid Opcional -->
                            <hr>
                             <button type="button" id="tool-undo" class="tool-button" title="Desfer (Ctrl+Z)">
                                 <img src="{{ url_for('static', path='img/icon-undo.svg') }}" alt="Undo">
                             </button>
                             <button type="button" id="tool-redo" class="tool-button" title="Refer (Ctrl+Y)">
                                 <img src="{{ url_for('static', path='img/icon-redo.svg') }}" alt="Redo">
                             </button>
                            <button type="button" id="tool-delete" class="tool-button" title="Esborrar Seleccionat (Supr)">
                                <img src="{{ url_for('static', path='img/icon-delete.svg') }}" alt="Delete">
                            </button>
                        </aside>
                        <section class="canvas-section">
                            <div id="canvas-wrapper">
                                <canvas id="roi-canvas"></canvas>
                            </div>
                             <div id="polygon-help-roi" class="tool-tip" style="display: none;">
                                 {{ i18n.get("polygon_tooltip", "Click to add points...") }}
                             </div>
                        </section>
                    </div>
                     <div class="navigation-buttons">
                         <button type="button" class="secondary" onclick="navigateStep('step-upload')">{{ i18n.get("back_to_upload_button", "Back to Upload") }}</button>
                        <button type="button" id="confirm-rois-button">{{ i18n.get("confirm_rois_button", "Confirm ROIs") }}</button>
                    </div>
                </div>

                <!-- PAS 2: Dades Manuals -->
                <div id="step-manual-data" class="step-content">
                    <header class="step-header">
                        <h2>{{ i18n.get("manual_data_title", "Manual Evaluation") }}</h2>
                         <p class="step-explanation">
                            {{ explanations.manual }}
                         </p>
                    </header>
                    <div class="tab-nav">
                        <button type="button" class="tab-link active" onclick="openTab(event, 'tab-clinical')">{{ i18n.get("tab_clinical", "Clinical Signs") }}</button>
                        <button type="button" class="tab-link" onclick="openTab(event, 'tab-radiographic')">{{ i18n.get("tab_radiographic", "Radiographic Signs") }}</button>
                    </div>

                     <div id="tab-clinical" class="tab-content active" style="display: block;"> <!-- Añadido active y display block inicial -->
                         <h3>{{ i18n.get("clinical_signs_subtitle", "Clinical Signs") }}</h3>
                          {% for key, options_list in clinical_options.items() %}
                         <div class="form-group">
                             <label for="{{ key }}">{{ key.replace('_', ' ').capitalize() }}:
                                <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ i18n.get('info_icon_tooltip', 'More information') }}">
                             </label>
                             <select id="{{ key }}" name="{{ key }}" required class="score-select">
                                 {% for option_text, score in options_list %}
                                     <!-- **CAMBIO CLAVE: value="{{ score }}"** -->
                                     <option value="{{ score }}" data-score="{{ score }}">{{ option_text }} ({{ score }} punts)</option>
                                 {% endfor %}
                             </select>
                         </div>
                         {% endfor %}
                     </div>
                     <div id="tab-radiographic" class="tab-content">
                          <h3>{{ i18n.get("radiographic_signs_subtitle", "Radiographic Signs") }}</h3>
                          {% for key, options_list in radiographic_options.items() %}
                          <div class="form-group">
                              <label for="{{ key }}">{{ key.replace('_', ' ').capitalize() }}:
                                 <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ i18n.get('info_icon_tooltip', 'More information') }}">
                              </label>
                              <select id="{{ key }}" name="{{ key }}" required class="score-select">
                                  {% for option_text, score in options_list %}
                                     <!-- **CAMBIO CLAVE: value="{{ score }}"** -->
                                      <option value="{{ score }}" data-score="{{ score }}">{{ option_text }} ({{ score }} punts)</option>
                                  {% endfor %}
                              </select>
                          </div>
                          {% endfor %}
                     </div>

                     <div class="navigation-buttons">
                         <button type="button" class="secondary" onclick="navigateStep('step-roi-editor')">{{ i18n.get("back_to_roi_button", "Back to ROI Edit") }}</button>
                        <!-- Cambiado a type="submit" -->
                        <button type="submit" id="calculate-button">{{ i18n.get("calculate_button", "Calculate Diagnosis") }}</button>
                    </div>
                </div>

            </form> <!-- Fin del formulario -->

            <!-- PAS 3: Resultats -->
             {% if results %}
            <div id="step-results" class="step-content results-screen active"> <!-- Añadido active si hay results -->
                 <header class="step-header">
                     <h2>{{ i18n.get("results_title", "Results") }}</h2>
                     <p class="step-explanation">
                        {{ explanations.results }}
                     </p>
                 </header>

                 <div class="results-layout">
                     <section class="results-details">
                         <h3>{{ i18n.get("score_breakdown_title", "Score Breakdown") }}</h3>
                         <div class="score-breakdown">
                             <div class="score-item">
                                 <!-- Usa textos i18n -->
                                 <h4>{{ i18n.get("clinical_score_label", "Clinical") }} <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ i18n.get('clinical_score_tooltip', 'Clinical score details') }}"></h4>
                                 <p>{{ results.puntuacio_clinica }} / {{ config.MAX_RAW_SCORES.clinical }}</p>
                                 <div class="score-bar-container"><div class="score-bar clinical" style="width: {{ (results.puntuacio_clinica / config.MAX_RAW_SCORES.clinical * 100)|int }}%;"></div></div>
                             </div>
                             <div class="score-item">
                                 <h4>{{ i18n.get("radiographic_score_label", "Radiographic") }} <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ i18n.get('radiographic_score_tooltip', 'Radiographic score details') }}"></h4>
                                 <p>{{ results.puntuacio_radio }} / {{ config.MAX_RAW_SCORES.radio }}</p>
                                 <div class="score-bar-container"><div class="score-bar radiographic" style="width: {{ (results.puntuacio_radio / config.MAX_RAW_SCORES.radio * 100)|int }}%;"></div></div>
                             </div>
                             <div class="score-item">
                                 <!-- Tooltip dinámico con valor DistEn -->
                                 {% set digital_tooltip = i18n.get('digital_score_tooltip', '').format(max_dist_en_value=results.max_dist_en_value) %}
                                 <h4>{{ i18n.get("digital_score_label", "Digital") }} <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ digital_tooltip if digital_tooltip else i18n.get('digital_score_no_tooltip', 'Digital score details') }}"></h4>
                                 <p>{{ results.puntuacio_digital }} / {{ config.MAX_RAW_SCORES.digital }}</p>
                                 <div class="score-bar-container"><div class="score-bar digital" style="width: {{ (results.puntuacio_digital / config.MAX_RAW_SCORES.digital * 100)|int }}%;"></div></div>
                             </div>
                         </div>
                         <p class="interpretation-text">
                             {{ results.interpretacio }} <!-- Texto ya viene de i18n vía backend -->
                         </p>

                         {% if results.roi_analysis_details %}
                         <details class="roi-details-results">
                             <summary>{{ i18n.get("roi_analysis_details_title", "ROI Analysis Details") }} <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ i18n.get('roi_analysis_details_tooltip', 'Details about individual ROI analysis') }}"></summary>
                             <ul>
                             {% for detail in results.roi_analysis_details %}
                                 <li>
                                     <!-- Texto i18n con placeholders -->
                                     {% set dist_en_text = detail.dist_en if detail.dist_en is not none else i18n.get('roi_analysis_na', 'N/A') %}
                                     {{ i18n.get('roi_analysis_item', 'ROI {roi_index}: DistEn2D = {dist_en}').format(roi_index=detail.roi_index, dist_en=dist_en_text) }}
                                     {% if detail.error %}
                                         <span class="error-text">{{ i18n.get('roi_analysis_error', '(Error: {error})').format(error=detail.error) }}</span>
                                     {% endif %}
                                 </li>
                             {% endfor %}
                             </ul>
                         </details>
                         {% endif %}
                     </section>

                     <section class="results-summary">
                         <h3>{{ i18n.get("integrated_score_title", "Global Score") }}</h3>
                          <!-- Termómetro -->
                         <div class="thermometer-display" data-score="{{ results.puntuacio_total_integrada }}" data-max="{{ config.MAX_INTEGRATED_SCORE }}">
                             <div class="thermometer-track">
                                 <div class="thermometer-fill"></div>
                             </div>
                             <div class="thermometer-bulb">
                                 <div class="thermometer-percentage">{{ (results.puntuacio_total_integrada / config.MAX_INTEGRATED_SCORE * 100)|round|int }}%</div>
                             </div>
                         </div>
                         <!-- Clasificación (texto ya viene de i18n) -->
                         <p class="classification-text" id="classification-text-id">
                            <strong>{{ i18n.get("classification_label", "Risk:") }} {{ results.classificacio }}</strong>
                         </p>
                     </section>
                 </div>

                 <div class="navigation-buttons">
                    <!-- Botón para volver al inicio -->
                    <button type="button" onclick="window.location.href='{{ url_for('read_root') }}';">{{ i18n.get("new_evaluation_button", "New Evaluation") }}</button>
                 </div>
            </div>
             {% endif %}

        </main>

        <footer class="app-footer">
            <p>© {{ now().year }} Desenvolupament de software independent. Version 1.1</p>
        </footer>

    </div> <!-- /app-container -->

    <!-- Scripts JS (al final) -->
    <!-- Primero Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

    <!-- Luego nuestra lógica principal y del editor (AHORA SOLO app.js) -->
    <script src="{{ url_for('static', path='/js/app.js') }}"></script>

</body>
</html>